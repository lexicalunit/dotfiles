#!/bin/bash -ue

# Finds definitions for terms.

# List of google sheet ids followed by a ; and a sheet name and range.
SHEETS=("1JdgLS3M0P-76Us5Uq6ZMEveJHmHFXX6j7PArLdEE-zg;Terms!B4:C")

usage() {
    (
        echo "usage: ${0##*/} [options] <query>" 1>&2
        echo "" 1>&2
        echo "Finds definitions for terms." 1>&2
        echo ""
        echo "options:"
        (
            echo "    -h, --help@ show usage help"
            echo "    -s@ case-sensitive"
            echo "    -o@ open source documents"
        ) | column -ts@
    ) >&2
    exit 1
}

if echo "$*" | grep -Eq -- '--help\b|-h\b'; then
    usage
fi

INSEN="-i"
OPEN="0"
while getopts "io" opt; do
    case "$opt" in
    i) INSEN="" ;;
    o) OPEN="1" ;;
    *) usage ;;
    esac
done
shift $((OPTIND - 1))
QUERY="$*"

if ! command -v jq >/dev/null 2>&1; then
    echo "error: please install jq (brew install jq)" >&2
    exit 1
fi

if ! command -v tbx >/dev/null 2>&1; then
    echo "error: please install watermint toolbox (brew tap watermint/toolbox && brew install toolbox)" >&2
    exit 1
fi

TMP="/tmp/terms"
echo "" >"$TMP"

# shellcheck disable=SC2068
for t in ${SHEETS[@]}; do
    IFS=';' read -ra IDS <<<"$t"
    if [[ $OPEN == "1" ]]; then
        open "https://docs.google.com/spreadsheets/d/${IDS[0]}"
    else
        echo "" >/tmp/terms
        tbx services google sheets sheet export \
            --output json \
            -id "${IDS[0]}" \
            -range "${IDS[1]}" |
            jq -rc |
            sed 's/\["\(.*\)","\(.*\)"\]/\1: \2/g' >>"$TMP"
    fi
done

# shellcheck disable=SC2086
grep -E --color $INSEN "$QUERY" <"$TMP"
