#!/bin/bash

# Install applications and development environment on an macOS or Linux machine.

################################################################################
# Settings
################################################################################
# BEGIN GENERATED PACKAGE LISTS
HOMEBREW_FORMULAS="                                                            \
    autoconf awscli bash brotli c-ares cabal-install chrome-cli coreutils      \
    defaultbrowser diff-so-fancy direnv duti exa exiftool expect fasd          \
    fontconfig freetype fribidi fzf gdbm gettext ghc ghostscript git git-lfs   \
    git-secrets glances glib gnu-sed gnu-tar go gobject-introspection          \
    graphite2 harfbuzz icu4c imagemagick@6 jbig2dec jemalloc                   \
    jez/formulae/pandoc-sidenote jpeg jq krb5 libev libevent libffi libidn     \
    libidn2 libpng libpthread-stubs libssh2 libtiff libtool libunistring libuv \
    libx11 libxau libxcb libxdmcp libxext libxrender libyaml little-cms2 lzo   \
    m4 mas mpdecimal ncurses nghttp2 node nvm oniguruma openjpeg openssl@1.1   \
    pandoc pango pcre pcre2 pidof pixman pkg-config postgresql pyenv           \
    pyenv-virtualenv pyenv-virtualenvwrapper pyright python@3.8 python@3.9     \
    readline ripgrep rlwrap rust shellcheck shfmt six sqlite tcl-tk tmux       \
    toolbox tree utf8proc vramsteg watch wdiff webp wget xorgproto xz yarn zsh"

HOMEBREW_CASKS="                                                               \
    1password 1password/tap/1password-cli chromedriver discord                 \
    disk-inventory-x docker dropbox fantastical flux font-fira-code            \
    font-hack-nerd-font google-chrome iexplorer iterm2 lingon-x mactex ngrok   \
    obsidian rectangle signal slack snes9x sourcetree spotify steam tableplus  \
    texstudio the-unarchiver transmission vagrant visual-studio-code vlc"

CODE_PACKAGES="                                                                \
    DavidAnson.vscode-markdownlint HookyQR.beautify James-Yu.latex-workshop    \
    PascalReitermann93.vscode-yaml-sort be5invis.toml bibhasdn.unique-lines    \
    charliermarsh.ruff dbaeumer.vscode-eslint eamodio.gitlens                  \
    esbenp.prettier-vscode exiasr.hadolint foxundermoon.shell-format           \
    hashicorp.terraform joe-re.sql-language-server karunamurti.haml            \
    mgmcdermott.vscode-language-babel mike-co.import-sorter                    \
    mohsen1.prettify-json ms-azuretools.vscode-docker                          \
    ms-python.black-formatter ms-python.python ms-python.vscode-pylance        \
    nickmillerdev.pytest-fixtures redhat.vscode-yaml                           \
    richie5um2.vscode-sort-json streetsidesoftware.code-spell-checker          \
    sysoev.language-stylus timonwong.shellcheck"

MAMBA_PACKAGES="                                                               \
    appdirs appnope attrs backcall brotlipy ca-certificates cachecontrol cachy \
    certifi cffi charset-normalizer cleo clikit crashtest cryptography         \
    decorator distlib filelock html5lib idna importlib-metadata                \
    importlib_metadata iniconfig ipython ipython_genutils jedi jsonschema      \
    keyring libcxx libffi lockfile lz4 lz4-c matplotlib-inline more-itertools  \
    msgpack-python ncurses openssl packaging parso pastel pexpect pickleshare  \
    pip pkginfo pluggy poetry poetry-core prompt-toolkit ptyprocess py pycosat \
    pycparser pygments pylev pyopenssl pyparsing pyrsistent pysocks pytest     \
    pyyaml readline requests requests-toolbelt ruamel_yaml setuptools          \
    shellingham six sqlite tk toml tomlkit tqdm traitlets urllib3 virtualenv   \
    wcwidth webencodings wheel xz yaml zipp zlib"

NODE_MODULES="                                                                 \
    @ibm/plex JSON all-contributors-cli create-react-app cson dockerlint       \
    eslint external-ip generator-code generator-generator geoip-lite           \
    js-beautify json-stable-stringify moment nesh npm-check-updates            \
    npm-remote-ls npm-why prettier raml2html standard tmpin typescript yo"

GO_PACKAGES="                                                                  \
    github.com/BurntSushi/toml"

CARGO_PACKAGES="                                                               \
    cargo-update jless loc porsmo"
# END GENERATED PACKAGE LISTS

ITEM_LISTS=(HOMEBREW_FORMULAS HOMEBREW_CASKS CODE_PACKAGES MAMBA_PACKAGES
    NODE_MODULES GO_PACKAGES CARGO_PACKAGES)

# Speeds things up when running homebrew commands
export HOMEBREW_NO_ANALYTICS=0

################################################################################
# Script Utilities
################################################################################
cleanup_item_list() {
    # A useful function for cleaning up the above item lists.
    # This is an implementation detail, and is used by update scripts.
    # Usage: equip -i (aka --items)
    local items_var lines leftover
    declare -a lines
    items_var="$1"
    lines=("$items_var=\"")
    eval "echo \$$items_var" |
        sed "s/  */ /g;s/^ *//g;" |
        tr ' ' '\n' |
        sort -u |
        tr '\n' ' ' |
        sed '$s/ $/\n/' |
        fold -w 75 -s - |
        sed 's/^/    /g;s/ $//g' |
        {
            while IFS=$'\n' read -r line; do lines+=("$line"); done
            for ((n = 0; n < ${#lines[@]}; n++)); do
                line="${lines[$n]}"
                leftover="$((80 - ${#line} - 1))"
                echo -n "$line"
                if [[ $((n + 1)) != "${#lines[@]}" ]]; then
                    for ((i = 1; i <= leftover; i++)); do
                        echo -n ' '
                    done
                    # shellcheck disable=SC1003
                    echo '\'
                else
                    echo '"'
                fi
            done
        }
    echo
}

show_items() {
    # Pretty prints an item list suitable for usage help.
    local list_name="$1"
    local list_title
    list_title="$(echo "$list_name" |
        tr '[:upper:]' '[:lower:]' |
        tr '_' ' ' |
        awk '{for (i=1;i <= NF;i++) {
            sub(".",substr(toupper($i),1,1),$i)} print}')"
    local output="$list_title:"
    output="$output $(eval "echo \$$list_name" | sed "s/^ *//g;s/  */, /g")"
    echo "$output" | fold -w 80 -s
    echo
}

usage() {
    (
        echo "usage: ${0##*/} [-l|-d|-f|-h|--help] [all|step-name(s)]"
        echo "Automatically installs and configures a complete *nix developer environment."
        echo
        echo "options:"
        (
            echo "    -h, --help: show usage help"
            echo "    -l: list available step names"
            echo "    -d: dry-run"
            echo "    -f: force install, do not ask for any confirmation"
            echo "    all: executes all steps"
            echo "    apps: executes steps that update applications"
            echo "    dot: executes dotfiles, zsh, and env"
            echo "    most: executes apps and dot"
            echo "    step-name(s): execute the given step(s)"
        ) | column -ts:
        echo
        echo "steps:"
        "$0" -l | sed 's/^/    /g'
        echo
        IFS=' '
        for I in "${ITEM_LISTS[@]}"; do
            show_items "$I"
        done
    ) >&2
    exit 1
}

# shellcheck source=../.shell_control
# shellcheck disable=SC1091
source "$HOME/.shell_control" || echo "$(tput bold)error: ~/.shell_control not installed!$(tput sgr0)" >&2

################################################################################
# Step Utilities
################################################################################
array_contains() {
    local seeking=$1
    shift
    local in=1
    for element; do
        # shellcheck disable=SC2053
        if [[ $element == $seeking ]]; then
            in=0
            break
        fi
    done
    return $in
}

ensure_no_mamba() {
    # Mamba is known to frequently break Homebrew builds, including Vim and
    # MacVim, due to bundling many duplicates of system and Homebrew-available
    # tools. Make sure to exit it before doing anything with Homebrew.
    if [[ -n $CONDA_PREFIX ]]; then
        run "mamba deactivate"
    fi
}

# Usage: in_array "$element" "${array[@]}"
in_array() {
    local e match="$1"
    shift
    for e; do [[ $e == "$match" ]] && return 0; done
    return 1
}

################################################################################
# Step osx -- a.k.a macOS
################################################################################
step_osx() {
    # Much of this step has been crafted from https://mths.be/osx

    ########################################
    # General UI/UX
    ########################################
    osascript -e 'tell application "System Preferences" to quit'

    HOST="$(uname -n)"
    query "Set hostname [$HOST]" "$HOST"
    if [[ -n $REPLY ]]; then
        run "sudo scutil --set HostName '$REPLY'"
    fi

    show "Set standby delay to 24 hours (default is 1 hour)"
    run "sudo pmset -a standbydelay 86400"

    show "Disable the sound effects on boot"
    run "sudo nvram SystemAudioVolume=' '"

    # show "Disable transparency in the menu bar and elsewhere on Yosemite"
    # run "defaults write com.apple.universalaccess reduceTransparency -bool true"

    # show "Set highlight color to green"
    # run "defaults write NSGlobalDomain AppleHighlightColor -string '0.764700 0.976500 0.568600'"

    show "Set sidebar icon size to medium"
    run "defaults write NSGlobalDomain NSTableViewDefaultSizeMode -int 2"

    # Possible values: `WhenScrolling`, `Automatic` and `Always`
    # show "Always show scrollbars"
    # run "defaults write NSGlobalDomain AppleShowScrollBars -string 'Always'"

    # show "Disable the over-the-top focus ring animation"
    # run "defaults write NSGlobalDomain NSUseAnimatedFocusRing -bool false"

    # (Uncomment if you’re on an older Mac that messes up the animation)
    # show "Disable smooth scrolling"
    # run "defaults write NSGlobalDomain NSScrollAnimationEnabled -bool false"

    show "Increase window resize speed for Cocoa applications"
    run "defaults write NSGlobalDomain NSWindowResizeTime -float 0.001"

    show "Expand save panel by default"
    run "defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true"
    run "defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true"

    show "Expand print panel by default"
    run "defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true"
    run "defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true"

    show "Save to disk (not to iCloud) by default"
    run "defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false"

    show "Automatically quit printer app once the print jobs complete"
    run "defaults write com.apple.print.PrintingPrefs 'Quit When Finished' -bool true"

    show "Disable the 'Are you sure you want to open this application?' dialog"
    run "defaults write com.apple.LaunchServices LSQuarantine -bool false"

    show "Remove duplicates in the 'Open With' menu (also see \`lscleanup\` alias)"
    run "/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -domain local -domain system -domain user"

    # Try e.g. `cd /tmp; unidecode "\x{0000}" > cc.txt; open -e cc.txt`
    show "Display ASCII control characters using caret notation in standard text views"
    run "defaults write NSGlobalDomain NSTextShowsControlCharacters -bool true"

    show "Disable Resume system-wide"
    run "defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool false"

    show "Disable automatic termination of inactive apps"
    run "defaults write NSGlobalDomain NSDisableAutomaticTermination -bool true"

    # show "Disable the crash reporter"
    # run "defaults write com.apple.CrashReporter DialogType -string 'none'"

    show "Set Help Viewer windows to non-floating mode"
    run "defaults write com.apple.helpviewer DevMode -bool true"

    # Commented out, as this is known to cause problems in various Adobe apps :(
    # See https://github.com/mathiasbynens/dotfiles/issues/237
    # show "Fix for the ancient UTF-8 bug in QuickLook" # See: https://mths.be/bbo
    # run "echo '0x08000100:0' > '$HOME/.CFUserTextEncoding'"

    show "Reveal IP address, hostname, OS version, etc. when clicking the clock in the login window"
    run "sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName"

    show "Restart automatically if the computer freezes"
    run "sudo systemsetup -setrestartfreeze on"

    show "Never go into computer sleep mode"
    run "sudo systemsetup -setcomputersleep Off >/dev/null"

    # show "Disable Notification Center and remove the menu bar icon"
    # run "launchctl unload -w /System/Library/LaunchAgents/com.apple.notificationcenterui.plist 2>/dev/null"

    show "Disable automatic capitalization as it’s annoying when typing code"
    run "defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false"

    show "Disable smart dashes as they’re annoying when typing code"
    run "defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false"

    show "Disable automatic period substitution as it’s annoying when typing code"
    run "defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false"

    show "Disable smart quotes as they’re annoying when typing code"
    run "defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false"

    show "Disable auto-correct"
    run "defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false"

    DESKTOP_WALLPAPER="$HOME/env/Rio Sunrise.jpg"
    if [[ -e $DESKTOP_WALLPAPER ]]; then
        show "Set wallpaper to $DESKTOP_WALLPAPER"

        # NOTE: Doesn't seem to work on BigSur
        run "sudo chown root:wheel '$DESKTOP_WALLPAPER'"
        run "sudo cp -uvf '$DESKTOP_WALLPAPER' /System/Library/CoreServices/DefaultDesktop.jpg"

        run "sudo mkdir -p /Users/Shared/Background"
        run "sudo cp -uvf '$DESKTOP_WALLPAPER' /Users/Shared/Background/custombg.jpeg"
        run "sudo chown -R root:wheel /Users/Shared/Background"

        MINOR_MACOS_VERSION="$(sw_vers | grep ProductVersion: | cut -f2 | cut -f2 -d.)"
        if [[ $MINOR_MACOS_VERSION -ge 9 ]]; then
            run "sqlite3 '$HOME/Library/Application Support/Dock/desktoppicture.db' 'delete from data;'"
            run "sqlite3 '$HOME/Library/Application Support/Dock/desktoppicture.db' 'insert into data values (\"$DESKTOP_WALLPAPER\");'"
        else
            run "defaults write com.apple.desktop Background '{default = {ImageFilePath = \"/Users/Shared/Background/custombg.jpeg\"; };}'"
        fi

        if command -v set_wallpaper >/dev/null 2>&1; then
            run "set_wallpaper --path '$DESKTOP_WALLPAPER'"
        fi
    fi

    ########################################
    # SSD-specific tweaks
    ########################################
    show "Disable hibernation (speeds up entering sleep mode)"
    run "sudo pmset -a hibernatemode 0"

    show "Remove the sleep image file to save disk space"
    run "sudo rm /private/var/vm/sleepimage"
    show "Create a zero-byte file instead…"
    run "sudo touch /private/var/vm/sleepimage"
    show "…and make sure it can’t be rewritten"
    run "sudo chflags uchg /private/var/vm/sleepimage"

    ########################################
    # Trackpad, mouse, keyboard, Bluetooth accessories, and input
    ########################################
    show "Trackpad: enable tap to click for this user and for the login screen"
    run "defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true"
    run "defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1"
    run "defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1"

    # show "Trackpad: map bottom right corner to right-click"
    # run "defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2"
    # run "defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true"
    # run "defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1"
    # run "defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true"

    show 'Disable “natural” (Lion-style) scrolling'
    run "defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false"

    show "Increase sound quality for Bluetooth headphones/headsets"
    run "defaults write com.apple.BluetoothAudioAgent 'Apple Bitpool Min (editable)' -int 40"

    show "Enable full keyboard access for all controls" # (e.g. enable Tab in modal dialogs)
    run "defaults write NSGlobalDomain AppleKeyboardUIMode -int 3"

    show "Use scroll gesture with the Ctrl (^) modifier key to zoom"
    run "sudo defaults write com.apple.universalaccess closeViewScrollWheelToggle -bool true"
    run "sudo defaults write com.apple.universalaccess HIDScrollZoomModifierMask -int 262144"

    show "Follow the keyboard focus while zoomed in"
    run "sudo defaults write com.apple.universalaccess closeViewZoomFollowsFocus -bool true"

    show "Disable press-and-hold for keys in favor of key repeat"
    run "defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false"

    show "Set a blazingly fast keyboard repeat rate"
    run "defaults write NSGlobalDomain KeyRepeat -int 1"
    run "defaults write NSGlobalDomain InitialKeyRepeat -int 10"

    show "Set language and text formats"
    run "defaults write NSGlobalDomain AppleLanguages -array 'en' 'nl'"
    run "defaults write NSGlobalDomain AppleLocale -string 'en_US@currency=USD'"
    run "defaults write NSGlobalDomain AppleMeasurementUnits -string 'Inches'"
    run "defaults write NSGlobalDomain AppleMetricUnits -bool false"

    show "Show language menu in the top right corner of the boot screen"
    run "sudo defaults write /Library/Preferences/com.apple.loginwindow showInputMenu -bool true"

    # See `sudo systemsetup -listtimezones` for other values
    show "Set the timezone to America/Chicago"
    run "sudo systemsetup -settimezone 'America/Chicago' >/dev/null"

    show "Stop iTunes from responding to the keyboard media keys"
    run "launchctl unload -w /System/Library/LaunchAgents/com.apple.rcd.plist 2>/dev/null"

    ########################################
    # Screen
    ########################################
    show "Require password immediately after sleep or screen saver begins"
    run "defaults write com.apple.screensaver askForPassword -int 1"
    run "defaults write com.apple.screensaver askForPasswordDelay -int 0"

    show "Save screenshots to the desktop"
    run "defaults write com.apple.screencapture location -string '${HOME}/Desktop'"

    show "Save screenshots in PNG format (other options: BMP, GIF, JPG, PDF, TIFF)"
    run "defaults write com.apple.screencapture type -string 'png'"

    show "Disable shadow in screenshots"
    run "defaults write com.apple.screencapture disable-shadow -bool true"

    # Reference: https://github.com/kevinSuttle/macOS-Defaults/issues/17#issuecomment-266633501
    show "Enable subpixel font rendering on non-Apple LCDs"
    run "defaults write NSGlobalDomain AppleFontSmoothing -int 1"

    show "Enable HiDPI display modes (requires restart)"
    run "sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true"

    ########################################
    # Finder
    ########################################
    show "Finder: allow quitting via ⌘ + Q; doing so will also hide desktop icons"
    run "defaults write com.apple.finder QuitMenuItem -bool true"

    show "Finder: disable window animations and Get Info animations"
    run "defaults write com.apple.finder DisableAllAnimations -bool true"

    # For other paths, use `PfLo` and `file:///full/path/here/`
    show "Set Desktop as the default location for new Finder windows"
    run "defaults write com.apple.finder NewWindowTarget -string 'PfDe'"
    run "defaults write com.apple.finder NewWindowTargetPath -string 'file://${HOME}/Desktop/'"

    show "Show icons for hard drives, servers, and removable media on the desktop"
    run "defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool true"
    run "defaults write com.apple.finder ShowHardDrivesOnDesktop -bool true"
    run "defaults write com.apple.finder ShowMountedServersOnDesktop -bool true"
    run "defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true"

    # show "Finder: show hidden files by default"
    # run "defaults write com.apple.finder AppleShowAllFiles -bool true"

    show "Finder: show all filename extensions"
    run "defaults write NSGlobalDomain AppleShowAllExtensions -bool true"

    show "Finder: show status bar"
    run "defaults write com.apple.finder ShowStatusBar -bool true"

    show "Finder: show path bar"
    run "defaults write com.apple.finder ShowPathbar -bool true"

    show "Display full POSIX path as Finder window title"
    run "defaults write com.apple.finder _FXShowPosixPathInTitle -bool true"

    show "Keep folders on top when sorting by name"
    run "defaults write com.apple.finder _FXSortFoldersFirst -bool true"

    show "When performing a search, search the current folder by default"
    run "defaults write com.apple.finder FXDefaultSearchScope -string 'SCcf'"

    show "Disable the warning when changing a file extension"
    run "defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false"

    show "Enable spring loading for directories"
    run "defaults write NSGlobalDomain com.apple.springing.enabled -bool true"

    show "Remove the spring loading delay for directories"
    run "defaults write NSGlobalDomain com.apple.springing.delay -float 0"

    show "Avoid creating .DS_Store files on network or USB volumes"
    run "defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true"
    run "defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true"

    show "Disable disk image verification"
    run "defaults write com.apple.frameworks.diskimages skip-verify -bool true"
    run "defaults write com.apple.frameworks.diskimages skip-verify-locked -bool true"
    run "defaults write com.apple.frameworks.diskimages skip-verify-remote -bool true"

    show "Automatically open a new Finder window when a volume is mounted"
    run "defaults write com.apple.frameworks.diskimages auto-open-ro-root -bool true"
    run "defaults write com.apple.frameworks.diskimages auto-open-rw-root -bool true"
    run "defaults write com.apple.finder OpenWindowForNewRemovableDisk -bool true"

    show "Show item info near icons on the desktop and in other icon views"
    run "/usr/libexec/PlistBuddy -c 'Set :DesktopViewSettings:IconViewSettings:showItemInfo true' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :FK_StandardViewSettings:IconViewSettings:showItemInfo true' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :StandardViewSettings:IconViewSettings:showItemInfo true' '$HOME/Library/Preferences/com.apple.finder.plist'"

    show "Show item info to the right of the icons on the desktop"
    run "/usr/libexec/PlistBuddy -c 'Set DesktopViewSettings:IconViewSettings:labelOnBottom false' '$HOME/Library/Preferences/com.apple.finder.plist'"

    show "Enable sort by Date Modified for icons on the desktop and in other icon views"
    run "/usr/libexec/PlistBuddy -c 'Set :DesktopViewSettings:IconViewSettings:arrangeBy dateModified' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :FK_StandardViewSettings:IconViewSettings:arrangeBy dateModified' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :StandardViewSettings:IconViewSettings:arrangeBy dateModified' '$HOME/Library/Preferences/com.apple.finder.plist'"

    show "Increase grid spacing for icons on the desktop and in other icon views"
    run "/usr/libexec/PlistBuddy -c 'Set :DesktopViewSettings:IconViewSettings:gridSpacing 100' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :FK_StandardViewSettings:IconViewSettings:gridSpacing 100' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :StandardViewSettings:IconViewSettings:gridSpacing 100' '$HOME/Library/Preferences/com.apple.finder.plist'"

    show "Increase the size of icons on the desktop and in other icon views"
    run "/usr/libexec/PlistBuddy -c 'Set :DesktopViewSettings:IconViewSettings:iconSize 80' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :FK_StandardViewSettings:IconViewSettings:iconSize 80' '$HOME/Library/Preferences/com.apple.finder.plist'"
    run "/usr/libexec/PlistBuddy -c 'Set :StandardViewSettings:IconViewSettings:iconSize 80' '$HOME/Library/Preferences/com.apple.finder.plist'"

    # Four-letter codes for the other view modes: `icnv`, `clmv`, `Flwv`
    show "Use list view in all Finder windows by default"
    run "defaults write com.apple.finder FXPreferredViewStyle -string 'Nlsv'"

    show "Disable the warning before emptying the Trash"
    run "defaults write com.apple.finder WarnOnEmptyTrash -bool false"

    show "Enable AirDrop over Ethernet and on unsupported Macs running Lion"
    run "defaults write com.apple.NetworkBrowser BrowseAllInterfaces -bool true"

    show "Show the ~/Library folder"
    run "chflags nohidden '$HOME/Library'"

    show "Show the /Volumes folder"
    run "sudo chflags nohidden /Volumes"

    # show "Remove Dropbox’s green checkmark icons in Finder"
    # run "test -e /Applications/Dropbox.app/Contents/Resources/emblem-dropbox-uptodate.icns && mv -f '$_' '$_.bak'"

    show 'Expand the following File Info panes: “General”, “Open with”, and “Sharing & Permissions”'
    run "defaults write com.apple.finder FXInfoPanesExpanded -dict General -bool true OpenWith -bool true Privileges -bool true"

    ########################################
    # Dock, Dashboard, and hot corners
    ########################################
    show "Enable highlight hover effect for the grid view of a stack (Dock)"
    run "defaults write com.apple.dock mouse-over-hilite-stack -bool true"

    show "Set the icon size of Dock items to 36 pixels"
    run "defaults write com.apple.dock tilesize -int 36"

    show "Change minimize/maximize window effect"
    run "defaults write com.apple.dock mineffect -string 'scale'"

    show "Minimize windows into their application’s icon"
    run "defaults write com.apple.dock minimize-to-application -bool true"

    show "Enable spring loading for all Dock items"
    run "defaults write com.apple.dock enable-spring-load-actions-on-all-items -bool true"

    show "Show indicator lights for open applications in the Dock"
    run "defaults write com.apple.dock show-process-indicators -bool true"

    # This is only really useful when setting up a new Mac, or if you don’t use the Dock to launch apps.
    # show "Wipe all (default) app icons from the Dock"
    # run "defaults write com.apple.dock persistent-apps -array"

    # show "Show only open applications in the Dock"
    # run "defaults write com.apple.dock static-only -bool true"

    show "Don’t animate opening applications from the Dock"
    run "defaults write com.apple.dock launchanim -bool false"

    show "Speed up Mission Control animations"
    defaults write com.apple.dock expose-animation-duration -float 0.1

    show "Don’t group windows by application in Mission Control" # (i.e. use the old Exposé behavior instead)
    defaults write com.apple.dock expose-group-by-app -bool false

    show "Disable Dashboard"
    run "defaults write com.apple.dashboard mcx-disabled -bool true"

    show "Don’t show Dashboard as a Space"
    run "defaults write com.apple.dock dashboard-in-overlay -bool true"

    show "Don’t automatically rearrange Spaces based on most recent use"
    run "defaults write com.apple.dock mru-spaces -bool false"

    show "Remove the auto-hiding Dock delay"
    run "defaults write com.apple.dock autohide-delay -float 0"

    show "Remove the animation when hiding/showing the Dock"
    run "defaults write com.apple.dock autohide-time-modifier -float 0"

    show "Disable automatically hide and show the Dock"
    run "defaults write com.apple.dock autohide -bool false"

    show "Make Dock icons of hidden applications translucent"
    run "defaults write com.apple.dock showhidden -bool true"

    # show "Disable the Launchpad gesture (pinch with thumb and three fingers)"
    # run "defaults write com.apple.dock showLaunchpadGestureEnabled -int 0"

    show "Reset Launchpad, but keep the desktop wallpaper intact"
    run "find '${HOME}/Library/Application Support/Dock' -name '*-*.db' -maxdepth 1 -delete"

    show "Add iOS & Watch Simulator to Launchpad"
    run "sudo ln -sf '/Applications/Xcode.app/Contents/Developer/Applications/Simulator.app' '/Applications/Simulator.app'"
    run "sudo ln -sf '/Applications/Xcode.app/Contents/Developer/Applications/Simulator (Watch).app' '/Applications/Simulator (Watch).app'"

    # show "Add a spacer to the left side of the Dock (where the applications are)"
    # run "defaults write com.apple.dock persistent-apps -array-add '{tile-data={}; tile-type=\"spacer-tile\";}'"
    # show "Add a spacer to the right side of the Dock (where the Trash is)"
    # run "defaults write com.apple.dock persistent-others -array-add '{tile-data={}; tile-type=\"spacer-tile\";}'"

    # Hot corners
    # Possible values:
    #      0: no-op
    #      2: Mission Control
    #      3: Show application windows
    #      4: Desktop
    #      5: Start screen saver
    #      6: Disable screen saver
    #      7: Dashboard
    #     10: Put display to sleep
    #     11: Launchpad
    #     12: Notification Center
    show "Top left screen corner -> Mission Control"
    run "defaults write com.apple.dock wvous-tl-corner -int 2"
    run "defaults write com.apple.dock wvous-tl-modifier -int 0"
    show "Top right screen corner -> Start screen saver"
    run "defaults write com.apple.dock wvous-tr-corner -int 5"
    run "defaults write com.apple.dock wvous-tr-modifier -int 0"
    show "Bottom right screen corner -> Desktop"
    run "defaults write com.apple.dock wvous-br-corner -int 4"
    run "defaults write com.apple.dock wvous-br-modifier -int 0"
    show "Bottom left screen corner -> Show application windows"
    run "defaults write com.apple.dock wvous-bl-corner -int 3"
    run "defaults write com.apple.dock wvous-bl-modifier -int 0"

    show "Disable Ctrl+Up Mission Control shortcut"
    run "defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 32 \"{enabled = 0; value = { parameters = (65535, 126, 8650752); type = 'standard'; }; }\""
    run "defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 34 \"{enabled = 0; value = { parameters = (65535, 126, 8781824); type = 'standard'; }; }\""

    show "Disable Ctrl+Down Mission Control shortcut"
    run "defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 33 \"{enabled = 0; value = { parameters = (65535, 125, 8650752); type = 'standard'; }; }\""
    run "defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 35 \"{enabled = 0; value = { parameters = (65535, 125, 8781824); type = 'standard'; }; }\""

    ########################################
    # Safari & WebKit
    ########################################
    show "Privacy: don’t send search queries to Apple"
    run "defaults write com.apple.Safari UniversalSearchEnabled -bool false"
    run "defaults write com.apple.Safari SuppressSearchSuggestions -bool true"

    show "Press Tab to highlight each item on a web page"
    run "defaults write com.apple.Safari WebKitTabToLinksPreferenceKey -bool true"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks -bool true"

    show "Show the full URL in the address bar (note: this still hides the scheme)"
    run "defaults write com.apple.Safari ShowFullURLInSmartSearchField -bool true"

    show "Set Safari’s home page to 'about:blank' for faster loading"
    run "defaults write com.apple.Safari HomePage -string 'about:blank'"

    show "Prevent Safari from opening ‘safe’ files automatically after downloading"
    run "defaults write com.apple.Safari AutoOpenSafeDownloads -bool false"

    show "Allow hitting the Backspace key to go to the previous page in history"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2BackspaceKeyNavigationEnabled -bool true"

    show "Hide Safari’s bookmarks bar by default"
    run "defaults write com.apple.Safari ShowFavoritesBar -bool false"

    show "Hide Safari’s sidebar in Top Sites"
    run "defaults write com.apple.Safari ShowSidebarInTopSites -bool false"

    show "Disable Safari’s thumbnail cache for History and Top Sites"
    run "defaults write com.apple.Safari DebugSnapshotsUpdatePolicy -int 2"

    show "Enable Safari’s debug menu"
    run "defaults write com.apple.Safari IncludeInternalDebugMenu -bool true"

    show "Make Safari’s search banners default to Contains instead of Starts With"
    run "defaults write com.apple.Safari FindOnPageMatchesWordStartsOnly -bool false"

    show "Remove useless icons from Safari’s bookmarks bar"
    run "defaults write com.apple.Safari ProxiesInBookmarksBar '()'"

    show "Enable the Develop menu and the Web Inspector in Safari"
    run "defaults write com.apple.Safari IncludeDevelopMenu -bool true"
    run "defaults write com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true"

    show "Add a context menu item for showing the Web Inspector in web views"
    run "defaults write NSGlobalDomain WebKitDeveloperExtras -bool true"

    show "Enable continuous spellchecking"
    run "defaults write com.apple.Safari WebContinuousSpellCheckingEnabled -bool true"
    show "Disable auto-correct"
    run "defaults write com.apple.Safari WebAutomaticSpellingCorrectionEnabled -bool false"

    show "Disable AutoFill"
    run "defaults write com.apple.Safari AutoFillFromAddressBook -bool false"
    run "defaults write com.apple.Safari AutoFillPasswords -bool false"
    run "defaults write com.apple.Safari AutoFillCreditCardData -bool false"
    run "defaults write com.apple.Safari AutoFillMiscellaneousForms -bool false"

    show "Warn about fraudulent websites"
    run "defaults write com.apple.Safari WarnAboutFraudulentWebsites -bool true"

    show "Disable plug-ins"
    run "defaults write com.apple.Safari WebKitPluginsEnabled -bool false"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2PluginsEnabled -bool false"

    show "Disable Java"
    run "defaults write com.apple.Safari WebKitJavaEnabled -bool false"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2JavaEnabled -bool false"

    show "Block pop-up windows"
    run "defaults write com.apple.Safari WebKitJavaScriptCanOpenWindowsAutomatically -bool false"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2JavaScriptCanOpenWindowsAutomatically -bool false"

    show "Disable auto-playing video"
    run "defaults write com.apple.Safari WebKitMediaPlaybackAllowsInline -bool false"
    run "defaults write com.apple.SafariTechnologyPreview WebKitMediaPlaybackAllowsInline -bool false"
    run "defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2AllowsInlineMediaPlayback -bool false"
    run "defaults write com.apple.SafariTechnologyPreview com.apple.Safari.ContentPageGroupIdentifier.WebKit2AllowsInlineMediaPlayback -bool false"

    show 'Enable “Do Not Track”'
    run "defaults write com.apple.Safari SendDoNotTrackHTTPHeader -bool true"

    show "Update extensions automatically"
    run "defaults write com.apple.Safari InstallExtensionUpdatesAutomatically -bool true"

    ########################################
    # Mail
    ########################################
    show "Disable send and reply animations in Mail.app"
    run "defaults write com.apple.mail DisableReplyAnimations -bool true"
    run "defaults write com.apple.mail DisableSendAnimations -bool true"

    # shellcheck disable=SC2016
    show 'Copy email addresses as `foo@example.com` instead of `Foo Bar <foo@example.com>` in Mail.app'
    run "defaults write com.apple.mail AddressesIncludeNameOnPasteboard -bool false"

    show "Display emails in threaded mode, sorted by date (oldest at the top)"
    run "defaults write com.apple.mail DraftsViewerAttributes -dict-add 'DisplayInThreadedMode' -string 'yes'"
    run "defaults write com.apple.mail DraftsViewerAttributes -dict-add 'SortedDescending' -string 'yes'"
    run "defaults write com.apple.mail DraftsViewerAttributes -dict-add 'SortOrder' -string 'received-date'"

    show "Disable inline attachments (just show the icons)"
    run "defaults write com.apple.mail DisableInlineAttachmentViewing -bool true"

    show "Disable automatic spell checking"
    run "defaults write com.apple.mail SpellCheckingBehavior -string 'NoSpellCheckingEnabled'"

    ########################################
    # Spotlight
    ########################################
    # show "Hide Spotlight tray-icon (and subsequent helper)"
    # run "sudo chmod 600 /System/Library/CoreServices/Search.bundle/Contents/MacOS/Search"

    # Use `sudo mdutil -i off "/Volumes/foo"` to stop indexing any volume.
    # show "Disable Spotlight indexing for any volume that gets mounted and has not yet been indexed before."
    # run "sudo defaults write /.Spotlight-V100/VolumeConfiguration Exclusions -array '/Volumes'"

    # Yosemite-specific search results (remove them if you are using macOS 10.9 or older):
    #   MENU_DEFINITION
    #   MENU_CONVERSION
    #   MENU_EXPRESSION
    #   MENU_SPOTLIGHT_SUGGESTIONS (send search queries to Apple)
    #   MENU_WEBSEARCH             (send search queries to Apple)
    #   MENU_OTHER
    show "Change indexing order and disable some search results..."
    defaults write com.apple.spotlight orderedItems -array \
        '{"enabled" = 1;"name" = "APPLICATIONS";}' \
        '{"enabled" = 1;"name" = "SYSTEM_PREFS";}' \
        '{"enabled" = 1;"name" = "DIRECTORIES";}' \
        '{"enabled" = 1;"name" = "PDF";}' \
        '{"enabled" = 1;"name" = "FONTS";}' \
        '{"enabled" = 0;"name" = "DOCUMENTS";}' \
        '{"enabled" = 0;"name" = "MESSAGES";}' \
        '{"enabled" = 0;"name" = "CONTACT";}' \
        '{"enabled" = 0;"name" = "EVENT_TODO";}' \
        '{"enabled" = 0;"name" = "IMAGES";}' \
        '{"enabled" = 0;"name" = "BOOKMARKS";}' \
        '{"enabled" = 0;"name" = "MUSIC";}' \
        '{"enabled" = 0;"name" = "MOVIES";}' \
        '{"enabled" = 0;"name" = "PRESENTATIONS";}' \
        '{"enabled" = 0;"name" = "SPREADSHEETS";}' \
        '{"enabled" = 0;"name" = "SOURCE";}' \
        '{"enabled" = 0;"name" = "MENU_DEFINITION";}' \
        '{"enabled" = 0;"name" = "MENU_OTHER";}' \
        '{"enabled" = 0;"name" = "MENU_CONVERSION";}' \
        '{"enabled" = 0;"name" = "MENU_EXPRESSION";}' \
        '{"enabled" = 0;"name" = "MENU_WEBSEARCH";}' \
        '{"enabled" = 0;"name" = "MENU_SPOTLIGHT_SUGGESTIONS";}'
    show "Load new settings before rebuilding the index"
    show "Make sure indexing is enabled for the main volume"
    run "sudo mdutil -i on / >/dev/null"
    show "Rebuild the index from scratch"
    run "sudo mdutil -E / >/dev/null"

    ########################################
    # Terminal & iTerm 2
    ########################################
    show "Only use UTF-8 in Terminal.app"
    run "defaults write com.apple.terminal StringEncodings -array 4"

    show "Use a modified version of the Solarized Light theme by default in Terminal.app..."
    osascript <<EOF
    tell application "Terminal"

        local allOpenedWindows
        local initialOpenedWindows
        local windowID
        set themeName to "Solarized Light xterm-256color"

        (* Store the IDs of all the open terminal windows. *)
        set initialOpenedWindows to id of every window

        (* Open the custom theme so that it gets added to the list
        of available terminal themes (note: this will open two
        additional terminal windows). *)
        do shell script "open '$HOME/env/" & themeName & ".terminal'"

        (* Wait a little bit to ensure that the custom theme is added. *)
        delay 1

        (* Set the custom theme as the default terminal theme. *)
        set default settings to settings set themeName

        (* Get the IDs of all the currently opened terminal windows. *)
        set allOpenedWindows to id of every window

        repeat with windowID in allOpenedWindows

        (* Close the additional windows that were opened in order
        to add the custom theme to the list of terminal themes. *)
        if initialOpenedWindows does not contain windowID then
            close (every window whose id is windowID)

            (* Change the theme for the initial opened terminal windows
            to remove the need to close them in order for the custom
            theme to be applied. *)
        else
            set current settings of tabs of (every window whose id is windowID) to settings set themeName
            end if

            end repeat

    end tell
EOF

    # i.e. hover over a window and start typing in it without clicking first
    # show 'Enable “focus follows mouse” for Terminal.app and all X11 apps'
    # run "defaults write com.apple.terminal FocusFollowsMouse -bool true"
    # run "defaults write org.x.X11 wm_ffm -bool true"

    # See: https://security.stackexchange.com/a/47786/8918
    show "Enable Secure Keyboard Entry in Terminal.app"
    run "defaults write com.apple.terminal SecureKeyboardEntry -bool true"

    show "Disable the annoying line marks"
    run "defaults write com.apple.Terminal ShowLineMarks -int 0"

    show "Install the Solarized Light theme for iTerm"
    run "open '${HOME}/env/Solarized Light.itermcolors'"

    show "Don’t display the annoying prompt when quitting iTerm"
    run "defaults write com.googlecode.iterm2 PromptOnQuit -bool false"

    ########################################
    # Time Machine
    ########################################
    show "Prevent Time Machine from prompting to use new hard drives as backup volume"
    run "defaults write com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true"

    # show "Disable local Time Machine backups"
    # run "hash tmutil &> /dev/null && sudo tmutil disablelocal"

    ########################################
    # Activity Monitor
    ########################################
    show "Show the main window when launching Activity Monitor"
    run "defaults write com.apple.ActivityMonitor OpenMainWindow -bool true"

    show "Visualize CPU usage in the Activity Monitor Dock icon"
    run "defaults write com.apple.ActivityMonitor IconType -int 5"

    show "Show all processes in Activity Monitor"
    run "defaults write com.apple.ActivityMonitor ShowCategory -int 0"

    show "Sort Activity Monitor results by CPU usage"
    run "defaults write com.apple.ActivityMonitor SortColumn -string 'CPUUsage'"
    run "defaults write com.apple.ActivityMonitor SortDirection -int 0"

    ########################################
    # Address Book, Dashboard, iCal, TextEdit, and Disk Utility
    ########################################
    show "Enable the debug menu in Address Book"
    run "defaults write com.apple.addressbook ABShowDebugMenu -bool true"

    show "Enable Dashboard dev mode (allows keeping widgets on the desktop)"
    run "defaults write com.apple.dashboard devmode -bool true"

    show "Enable the debug menu in iCal (pre-10.8)"
    run "defaults write com.apple.iCal IncludeDebugMenu -bool true"

    show "Use plain text mode for new TextEdit documents"
    run "defaults write com.apple.TextEdit RichText -int 0"
    show "Open and save files as UTF-8 in TextEdit"
    run "defaults write com.apple.TextEdit PlainTextEncoding -int 4"
    run "defaults write com.apple.TextEdit PlainTextEncodingForWrite -int 4"

    show "Enable the debug menu in Disk Utility"
    run "defaults write com.apple.DiskUtility DUDebugMenuEnabled -bool true"
    run "defaults write com.apple.DiskUtility advanced-image-options -bool true"

    show "Auto-play videos when opened with QuickTime Player"
    run "defaults write com.apple.QuickTimePlayerX MGPlayMovieOnOpen -bool true"

    ########################################
    # Mac App Store
    ########################################
    show "Enable the WebKit Developer Tools in the Mac App Store"
    run "defaults write com.apple.appstore WebKitDeveloperExtras -bool true"

    show "Enable Debug Menu in the Mac App Store"
    run "defaults write com.apple.appstore ShowDebugMenu -bool true"

    show "Enable the automatic update check"
    run "defaults write com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true"

    show "Check for software updates daily, not just once per week"
    run "defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1"

    show "Download newly available updates in background"
    run "defaults write com.apple.SoftwareUpdate AutomaticDownload -int 1"

    show "Install System data files & security updates"
    run "defaults write com.apple.SoftwareUpdate CriticalUpdateInstall -int 1"

    show "Automatically download apps purchased on other Macs"
    run "defaults write com.apple.SoftwareUpdate ConfigDataInstall -int 1"

    show "Turn on app auto-update"
    run "defaults write com.apple.commerce AutoUpdate -bool true"

    show "Allow the App Store to reboot machine on macOS updates"
    run "defaults write com.apple.commerce AutoUpdateRestartRequired -bool true"

    ########################################
    # Photos
    ########################################
    show "Prevent Photos from opening automatically when devices are plugged in"
    run "defaults -currentHost write com.apple.ImageCapture disableHotPlug -bool true"

    ########################################
    # Messages
    ########################################
    show "Disable automatic emoji substitution (i.e. use plain text smileys)"
    run "defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add 'automaticEmojiSubstitutionEnablediMessage' -bool false"

    show "Disable smart quotes as it’s annoying for messages that contain code"
    run "defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add 'automaticQuoteSubstitutionEnabled' -bool false"

    show "Disable continuous spell checking"
    run "defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add 'continuousSpellCheckingEnabled' -bool false"

    ########################################
    # Google Chrome & Google Chrome Canary
    ########################################
    show "Disable the all too sensitive backswipe on trackpads"
    run "defaults write com.google.Chrome AppleEnableSwipeNavigateWithScrolls -bool false"
    run "defaults write com.google.Chrome.canary AppleEnableSwipeNavigateWithScrolls -bool false"

    show "Disable the all too sensitive backswipe on Magic Mouse"
    run "defaults write com.google.Chrome AppleEnableMouseSwipeNavigateWithScrolls -bool false"
    run "defaults write com.google.Chrome.canary AppleEnableMouseSwipeNavigateWithScrolls -bool false"

    show "Use the system-native print preview dialog"
    run "defaults write com.google.Chrome DisablePrintPreview -bool true"
    run "defaults write com.google.Chrome.canary DisablePrintPreview -bool true"

    show "Expand the print dialog by default"
    run "defaults write com.google.Chrome PMPrintingExpandedStateForPrint2 -bool true"
    run "defaults write com.google.Chrome.canary PMPrintingExpandedStateForPrint2 -bool true"

    ########################################
    # Default Web Browser
    ########################################
    if command -v defaultbrowser >/dev/null 2>&1; then
        show "Attempting to set Firefox as default Web Browser..."
        run "defaultbrowser firefox"
    fi

    ########################################
    # Keyboard Remapping
    ########################################
    show "Remap 'caps lock' to 'esc'"
    run "hidutil property --set '{\"UserKeyMapping\":[{\"HIDKeyboardModifierMappingSrc\":0x700000039,\"HIDKeyboardModifierMappingDst\":0x700000029}]}'"

    ########################################
    # Kill affected applications
    ########################################
    run "nohup killall Calendar cfprefsd Contacts Mail mds Messages Photos Safari >/dev/null 2>&1" &
    run "nohup killall 'Activity Monitor' 'Address Book' 'Google Chrome Canary' 'Google Chrome' >/dev/null 2>&1" &
    run "nohup killall Dock Finder >/dev/null 2>&1" &
    run "nohup killall SystemUIServer >/dev/null 2>&1" &
    show -i "Done. Note that some of these changes require a logout/restart to take effect."
}

################################################################################
# Step xcode
################################################################################
step_xcode() {
    run "xcode-select --install"
    if run "cc --version 2>/dev/null 1>&2"; then
        show "Xcode agreement is accepted."
    else
        show "Xcode agreement not accepted..."
        run "sudo xcodebuild -license" || abort "Xcode agreement NOT accepted"
    fi
    show "Xcode Command Line Tools are properly installed."
}

################################################################################
# Step brew
################################################################################
ensure_homebrew_updated() {
    if [[ -z "$(command -v brew)" ]]; then
        abort "Please run step brew first"
    fi

    ensure_no_mamba

    # unlink keg-only formulas which should not be not symlinked into brew path
    KEG_ONLY=(gettext libffi libtool openssl readline sqlite)
    for f in "${KEG_ONLY[@]}"; do
        run "brew unlink $f"
    done

    run "brew update"
    run "brew upgrade"
}

ensure_homebrew_updated_cleanup() {
    # Force link these keg-only formulas to override outdated system versions.
    # Must be called sometime after ensure_homebrew_updated() has been called,
    # and after any other brew commands such as install have also been called.
    run "brew link --force --overwrite sqlite imagemagick@6"

    # Spotify has started forcing itself to be started at login like some kind
    # of fucking malware. Nuke that shit from orbit.
    run "rm -rf /Applications/Spotify.app/Contents/Library/LoginItems/*" || true
}

install_brew_formula() {
    local FORMULA_NAME FORMULA="$1"
    FORMULA_NAME="$(basename "$1" "/")"
    shift

    IFS=' ' read -r -a INSTALLED <<<"$@"
    if ! in_array "$FORMULA_NAME" "${INSTALLED[@]}"; then
        run "brew install '$FORMULA'"
    else
        show "brew formula '$FORMULA' already installed"
    fi

    # Force link the most recent version; can fix some annoying issues,
    # but is also slow and terrible and shouldn't be necessary.
    # run "brew unlink $1 && brew link --force --overwrite $1"
}

step_brew() {
    ensure_no_mamba

    if [[ -z "$(command -v brew)" ]]; then
        show "installing homebrew..."
        # shellcheck disable=SC2016
        run 'ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"'

        # make sure brew is in your PATH before continuing:
        test -d /usr/local/bin && PATH="$PATH:$_"
        test -d /opt/homebrew/bin && PATH="$PATH:$_"
        export PATH
    else
        show "Homebrew already installed"
    fi

    if [[ -z "$(command -v brew)" ]]; then
        abort "Failed to install Homebrew"
    fi

    run "sudo -v"
    run "sudo chown '$(whoami)' $(dirname "$BREW_PREFIX")"
    run "find '$(brew --prefix)' -mindepth 1 -maxdepth 1 -print0 | xargs -0 -n 1 -P $(sysctl -n hw.ncpu) sudo chown -R '$(whoami)'"

    # shellcheck disable=SC2207
    TAP=($(brew tap))
    array_contains 'watermint/toolbox' "${TAP[@]}" || run "brew tap watermint/toolbox"

    ensure_homebrew_updated

    local INSTALLED
    brew ls --formula -1 | {
        while IFS="" read -r line; do INSTALLED+=("$line"); done
        IFS=' '
        for I in $HOMEBREW_FORMULAS; do
            install_brew_formula "$I" "${INSTALLED[@]}"
        done
    }

    ensure_homebrew_updated_cleanup

    # cmake's bundling utility fails in completely reasonable cases, the following steps are necessary
    run "chmod +w /usr/local/Cellar/freetds/*/lib/*.dylib 2>/dev/null"
    run "chmod +w /usr/local/Cellar/pcre/*/lib/*.dylib 2>/dev/null"

    # install Amphetamine via Mac Apple Store CLI
    if [[ ! -e "/Applications/Amphetamine.app" ]]; then
        show -i "Attempting to install Amphetamine via the Mac App Store CLI..."
        run "mas lucky Amphetamine"
        run "open /Applications/Amphetamine.app"
    fi

    run "mkdir -p $HOME/bin"
    run "ln -sf '$(brew --prefix python@3.9)/libexec/bin/python' '$HOME/bin/python3.9'"
    run "ln -sf '$(brew --prefix python@3.8)/libexec/bin/python' '$HOME/bin/python3.8'"
    run "ln -sf '$(brew --prefix shfmt)/bin/shfmt' '$HOME/bin/.'"
    run "ln -sf '$(brew --prefix shellcheck)/bin/shellcheck' '$HOME/bin/.'"

    local arr=()
    echo "$HOMEBREW_FORMULAS" | tr ' ' '\n' | {
        while IFS="" read -r line; do arr+=("$line"); done
        for name in $(brew ls --formula -l | tail -n +2 | awk '{print $NF}'); do
            [[ $name == "pandoc-sidenote" ]] && name="jez/formulae/$name"
            if ! in_array "$name" "${arr[@]}"; then
                show -i "$name installed but not managed by equip via brew"
            fi
        done
    }
}

################################################################################
# Step cask
################################################################################
install_brew_cask() {
    local FORMULA_NAME FORMULA="$1"
    FORMULA_NAME="$(basename "$1" "/")"
    shift

    local FOUND
    IFS=$'\n' read -r -d '' -a FOUND < <(find /Applications ~/Applications -maxdepth 1 -name "*.app" -exec basename {} \; && printf '\0')

    local INSTALLED
    IFS=' ' read -r -a INSTALLED <<<"$@"
    if ! in_array "$FORMULA_NAME" "${INSTALLED[@]}"; then
        APP_NAME="$(brew info --cask --json=v2 "$FORMULA_NAME" | jq -r '.casks[].artifacts[]' | grep '.app' | tr -d '"' | sed 's/^ *//g' | head -n 1)"
        APP_NAME="$(basename "$APP_NAME")"
        if [[ -n $APP_NAME ]] && echo "${FOUND[*]}" | grep -qE "\b$APP_NAME\b"; then
            show "It seems that the $APP_NAME application is already installed."
        else
            run "brew install --cask '$FORMULA'"
        fi
    else
        show "brew cask formula '$FORMULA' already installed"
    fi
}

step_cask() {
    echo
    show -i "================================================================================"
    show -i "= Installing Casks is ESPECIALLY interactive, you WILL need to babysit this!   ="
    show -i "= For example, many Casks require additional manual steps after installation.  ="
    show -i "================================================================================"
    echo

    ensure_homebrew_updated

    # shellcheck disable=SC2207
    TAP=($(brew tap))
    array_contains 'homebrew/cask-fonts' "${TAP[@]}" || run "brew tap homebrew/cask-fonts"
    array_contains 'homebrew/cask-versions' "${TAP[@]}" || run "brew tap homebrew/cask-versions"

    local INSTALLED
    brew ls --cask -1 | {
        while IFS="" read -r line; do INSTALLED+=("$line"); done
        IFS=' '
        for I in $HOMEBREW_CASKS; do
            install_brew_cask "$I" "${INSTALLED[@]}"
        done
    }

    # Configure Rectangle's default settings
    run "defaults write com.knollsoft.Rectangle ignoredSnapAreas -int 1"
    run "defaults write com.knollsoft.Rectangle unsnapRestore -int 2"
    run "defaults write com.knollsoft.Rectangle launchOnLogin -int 1"

    ensure_homebrew_updated_cleanup

    IFS=$'\n'
    for I in $(brew ls --cask -1); do
        name="${I%@*}"
        if ! echo "$HOMEBREW_CASKS" | grep -Eq "$(echo "\\b$name\\b" | sed 's/ (!)//g')"; then
            if [[ $I != "mamba" ]]; then
                show -i "$I installed but not managed by equip via brew cask"
            fi
        fi
    done
}

################################################################################
# Step ext
################################################################################
step_ext() {
    if ! command -v duti >/dev/null 2>&1; then
        ensure_homebrew_updated
        install_brew_formula duti || abort "Can't install duti via brew"
        ensure_homebrew_updated_cleanup
    fi
    run "duti -v '$HOME/env/extensions.duti'"
}

################################################################################
# Step code
################################################################################
install_code_pkg() {
    local INSTALLED PKG="$1"
    shift
    IFS=' ' read -r -a INSTALLED <<<"$@"

    if ! in_array "$PKG" "${INSTALLED[@]}"; then
        run "code --force --install-extension '$PKG'" || abort "Can not install package '$PKG'"
    else
        show "skipping $PKG: already installed"
    fi
}

step_code() {
    if ! command -v code >/dev/null 2>&1; then
        ensure_homebrew_updated
        install_brew_cask visual-studio-code || abort "Can't install VS Code via brew-cask"
        ensure_homebrew_updated_cleanup
    fi

    local INSTALLED
    INSTALLED=()
    code --list-extensions | {
        while IFS="" read -r line; do INSTALLED+=("$line"); done
        IFS=' '
        for I in $CODE_PACKAGES; do
            install_code_pkg "$I" "${INSTALLED[@]}"
        done
    }

    IFS=$'\n'
    for I in $(code --list-extensions); do
        name="${I%@*}"
        if ! echo "$CODE_PACKAGES" | grep -Eqi "\\b${name}\\b"; then
            show -i "$I installed but not managed by equip via code"
        fi
    done
}

################################################################################
# Step zsh
################################################################################
ensure_add_shell() {
    local BINARY="$1"
    local INSTALLED
    INSTALLED="$(grep "$BINARY" /etc/shells)"
    if [[ $INSTALLED == "" ]]; then
        run "echo '$BINARY' | sudo tee -a /etc/shells"
    fi
}

ensure_shell() {
    NAME="$1"
    shift

    ensure_homebrew_updated

    for FORMULA in "$@"; do
        install_brew_formula "$FORMULA"
    done

    ensure_homebrew_updated_cleanup

    SHELL_BINARY="$(brew ls --formula "$NAME" | grep "^.*/bin/.*$NAME\$")"
    ensure_add_shell "$SHELL_BINARY"

    BREW_SHELL_BINARY="$(brew --prefix)/bin/$NAME"
    ensure_add_shell "$BREW_SHELL_BINARY"
    run "sudo chsh -s '$BREW_SHELL_BINARY' '$(whoami)'"
}

step_zsh() {
    ensure_shell zsh zsh
}

################################################################################
# Step bash
################################################################################
step_bash() {
    # Not installing formula bash-completion here, because that is installed
    # by env/install. This is to get the most up to date development version
    # with git (if able), or to install from a tarball if git is not available.
    ensure_shell bash bash
}

################################################################################
# Step python
################################################################################
step_python() {
    if run "command -v mamba >/dev/null 2>&1"; then
        show "mamba already installed"
    else
        ensure_homebrew_updated
        cd /tmp && {
            run "curl -L -O 'https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh'"
            cd - || exit 1
        }
        run "chmod +x /tmp/Mambaforge-$(uname)-$(uname -m).sh"
        run "/tmp/Mambaforge-$(uname)-$(uname -m).sh -bu"
        ensure_homebrew_updated_cleanup
    fi

    if [[ -z $CONDA_PREFIX ]]; then
        run "mamba activate"
    fi

    # Install mamba packages that don't come pre-installed with mamba
    local MAMBA_LIST
    MAMBA_LIST="$(mamba list --json | jq -r '.[].name' | grep -Ev '^python$')"
    IFS=' '
    for I in $MAMBA_PACKAGES; do
        if ! echo "$MAMBA_LIST" | grep -q "$I"; then
            run "mamba install -q -c conda-forge --yes $I"
        fi
    done

    IFS=$'\n'
    for I in $MAMBA_LIST; do
        name="${I%@*}"
        if ! echo "$MAMBA_PACKAGES" | grep -Eq "\\b$name\\b"; then
            show -i "$I installed but not managed by equip via mamba"
        fi
    done
}

################################################################################
# Step node
################################################################################
step_node() {
    if ! command -v node >/dev/null 2>&1; then
        ensure_homebrew_updated
        install_brew_formula node
        ensure_homebrew_updated_cleanup
    elif command -v brew >/dev/null 2>&1; then
        run "brew upgrade node"
    fi

    # Ensure that we're installing to the system's Node
    if command -v nvm >/dev/null 2>&1; then
        run "nvm alias default system"
        run "nvm use system"
    fi

    # Homebrew Caveat
    # If you update npm itself, do NOT use the npm update command.
    # The upstream-recommended way to update npm is:
    run "npm install -g npm@latest"
    run "npm update -g"

    local INSTALLED
    INSTALLED="$(npm list -g --depth 0 2>/dev/null | sed 's/^.*UNMET PEER DEPENDENCY \([^@]*\)@\([^ ]*\).*$/├── UNMET-\1@\2/g' | grep @ | cut -d' ' -f2 | cut -d@ -f1)"

    IFS=' '
    for I in $NODE_MODULES; do
        if ! echo "$INSTALLED" | grep -Eq "\\b$I\\b"; then
            run "npm install -g $I"
        fi
    done

    # install the @ibm/plex monospace fonts
    run "cp -uvf '$(npm -g config get prefix)/lib/node_modules/@ibm/plex/IBM-Plex-Mono/fonts/complete/woff'/*.woff /Library/Fonts/."

    IFS=$'\n'
    for I in $INSTALLED; do
        name="${I%@*}"
        if [[ $name == "npm" ]]; then
            continue
        fi
        if [[ $name == "UNMET-"* ]]; then
            UNMET="${name#*-}"
            show -i "UNMET PEER DEPENDENCY: $UNMET; you should probably npm install it"
        elif ! echo "$NODE_MODULES" | grep -Eq "\\b$name\\b"; then
            show -i "$I installed but not managed by equip via npm"
        fi
    done
}

################################################################################
# Step go
################################################################################
step_go() {
    if ! command -v go >/dev/null 2>&1; then
        ensure_homebrew_updated
        install_brew_formula go
        ensure_homebrew_updated_cleanup
    elif command -v brew >/dev/null 2>&1; then
        run "brew upgrade go"
    fi

    GOPATH="/opt/gopath/$ARCH"
    if [[ ! -d $GOPATH ]]; then
        mkdir -p "$GOPATH"
    fi
    test -d "$GOPATH/bin" && PATH="$PATH:$_"
    test -d "$BREW_PREFIX/opt/go/libexec/bin" && PATH="$PATH:$_"
    export PATH
    export GOPATH

    run "GO111MODULE=off go get -u all"

    if ! command -v golist >/dev/null 2>&1; then
        show -i "Utility golist is not installed in your PATH."
        show -i "Please install it from https://github.com/lexicalunit/dotfiles/blob/master/bin/golist"
        return 1
    fi

    INSTALLED="$(golist -r | tr '\n' ' ')"

    IFS=' '
    for I in $GO_PACKAGES; do
        if ! echo "$INSTALLED" | grep -Eq "\\b$I\\b"; then
            run "go get -u $I"
        else
            show "go module $I is already installed"
        fi
    done

    IFS=' '
    for install_name in $INSTALLED; do
        FOUND="false"
        for pkg in $GO_PACKAGES; do
            if echo "$install_name" | grep -Eq "\\b$pkg\\b"; then
                FOUND="true"
                break
            fi
        done
        if [[ $FOUND != "true" ]]; then
            show -i "$install_name installed but not managed by equip via go get"
        fi
    done
}

################################################################################
# Step cargo
################################################################################
step_cargo() {
    if ! command -v rustc >/dev/null 2>&1; then
        ensure_homebrew_updated
        install_brew_formula rust
        ensure_homebrew_updated_cleanup
    elif command -v brew >/dev/null 2>&1; then
        run "brew upgrade rust"
    fi

    declare -a INSTALLED
    INSTALLED=()
    cargo install --list | grep -v "^ " | sed 's/ v.*//g' | {
        while IFS="" read -r line; do INSTALLED+=("$line"); done
        IFS=' '
        for I in $CARGO_PACKAGES; do
            if ! echo "${INSTALLED[*]}" | grep -Eq "\\b$I\\b"; then
                run "cargo install $I"
            fi
        done
    }

    run "cargo install-update -a"

    IFS=' '
    for install_name in $(cargo install --list | grep -v "^ " | sed 's/ v.*//g'); do
        echo ") $install_name"
        FOUND="false"
        for pkg in $CARGO_PACKAGES; do
            echo "  - $pkg"
            if echo "$install_name" | grep -Eq "\\b$pkg\\b"; then
                FOUND="true"
                break
            fi
        done
        if [[ $FOUND != "true" ]]; then
            show -i "$install_name installed but not managed by equip via cargo"
        fi
    done
}

################################################################################
# Step env
################################################################################
step_env() {
    if ! git status >/dev/null 2>&1; then
        abort "Please run step dotfiles first"
    fi

    # install submodules
    run "cd '$HOME'" || exit 1
    run "git submodule update --init --recursive"
    run "git submodule update --init --recursive --remote"

    # install my prezto prompt
    if [[ -d ".zprezto/modules/prompt/functions" ]]; then
        run "cp -uvf '$HOME/env/prompt_lexical_setup' '$HOME/.zprezto/modules/prompt/functions'"
    fi

    # install git hooks
    run "cd '$HOME/.git/hooks'" || exit 1
    run "find . -type f -print0 | xargs -0 rm -v"
    run "ln -sf '../../env/pre-commit' ."
    run "ln -sf '../../env/post-commit' ."

    # install fonts
    run "cp -uvf '$HOME'/env/*.otf /Library/Fonts/."
}

################################################################################
# Step dotfiles
################################################################################
step_dotfiles() {
    run "cd '$HOME'"
    ROOT="$(git rev-parse --show-toplevel 2>&1)"
    if [[ $ROOT != "$PWD" ]]; then
        run "git init" || abort "Please ensure git is installed"
    fi

    if ! git remote -v | grep -q git@github.com:lexicalunit/dotfiles.git; then
        run "git remote add origin git@github.com:lexicalunit/dotfiles.git"
    fi

    BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
    if [[ $BRANCH != "master" && $BRANCH != "HEAD" ]]; then
        abort "Branch '$BRANCH' is not the default branch, please checkout the 'master' branch"
    fi

    run "git fetch origin master" || abort "Please setup ssh access to github: https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh"

    CHANGES="$(git status --porcelain=v1 2>/dev/null | wc -l)"
    if [[ $CHANGES != "0" ]]; then
        ask "There are existing changes in your working tree, continue anyway?"
        if [[ $REPLY != "y" ]]; then
            abort "Please commit or discard existing changes before proceeding"
        fi
    fi

    run "git reset --hard FETCH_HEAD"
    run "git branch -u origin/master"
    run "git submodule update --recursive --init"
}

################################################################################
# Main
################################################################################
if [[ $(id -u) == 0 ]]; then
    echo "Do not run this script as root." >&2
    exit 1
fi

if echo "$*" | grep -Eq -- '--help\b|-h\b'; then
    usage
fi

if echo "$*" | grep -Eq -- '--items\b|-i\b'; then
    IFS=' '
    for I in "${ITEM_LISTS[@]}"; do
        cleanup_item_list "$I"
    done
    exit 0
fi

OPTIND=1
LISTING=0
FORCE=0
ALL=0
DRYRUN=0
while getopts "lfd" opt; do
    case "$opt" in
    l) LISTING=1 ;;
    f) FORCE=1 ;;
    d) DRYRUN=1 ;;
    *) usage ;;
    esac
done
shift $((OPTIND - 1))

# export force/dryrun settings to shell control variables (see ~/.shell_control)
export SC_FORCE="$FORCE"
export SC_DRYRUN="$DRYRUN"

if [[ $LISTING == 0 && -z $1 ]]; then
    usage
fi

if [[ $1 == all ]]; then
    ALL=1
    shift
fi

ARGS="$*"

# update everything but osx
if echo "$ARGS" | grep -Eq -- 'most\b'; then
    ARGS="$ARGS apps dot"
fi

# update applications
if echo "$ARGS" | grep -Eq -- 'apps\b'; then
    ARGS="$ARGS xcode brew cask ext python node go cargo code"
fi

# update environment and dotfiles
if echo "$ARGS" | grep -Eq -- 'dot\b'; then
    ARGS="$ARGS dotfiles zsh env"
fi

# key;  question
steps=(
    "xcode;         Ensure that Xcode Command Line Tools are installed"
    "dotfiles;      Ensure home directory is a git repository for dotfiles"
    "brew;          Ensure Homebrew installed, formulas upgraded, and Amphetamine installed"
    "cask;          Ensure Homebrew Casks are installed"
    "ext;           Ensure file extension associations are correct"
    "zsh;           Ensure shell is latest version of zsh from Homebrew"
    "env;           Update environment configuration and submodules"
    "python;        Upgrade/Install python and mamba packages"
    "node;          Ensure Node modules are installed via npm"
    "go;            Ensure Go packages are installed"
    "cargo;         Ensure Rust packages are installed via cargo"
    "code;          Ensure VS Code installed via Homebrew Cask and its packages are installed"
    'osx;           Override macOS "defaults" settings and configuration'
    "dot;           Runs steps: dotfiles zsh env"
    "apps;          Runs steps: xcode brew cask ext python node go cargo code"
    "most;          Runs steps: apps dot (basically everything but the osx step)"
    "all;          Runs all steps"
)

LISTING_OUTPUT=""

IFS=$'\n'
((steps_taken = 0))
for step in "${steps[@]}"; do
    key="$(echo "$step" | cut -d';' -f1)"
    question="$(echo "$step" | cut -d';' -f2 | sed 's/^ *//g')"
    function="step_$key"

    if [[ $LISTING == 1 ]]; then
        LISTING_OUTPUT="$LISTING_OUTPUT$key; $question"$'\n'
        continue
    fi

    if [[ $ALL == 0 ]] && ! echo "$ARGS" | grep -Eq "\\b$key\\b"; then
        continue
    fi

    # don't try to run the meta steps directly
    if echo "$step" | grep -Eq '\bdot\b|\bapps\b|\bmost\b|\ball\b'; then
        continue
    fi

    ((steps_taken = steps_taken + 1))
    ask "[$key] $question?"
    if [[ $REPLY == "y" ]]; then
        show "Beginning step [$key]"
        eval "$function"
    fi
done

if [[ $LISTING == 1 ]]; then
    echo -n "$LISTING_OUTPUT" | column -ts ';'
fi

if [[ $LISTING == 0 && $steps_taken == 0 ]]; then
    abort "invalid step name(s): $(echo "$*" | tr '\n' ' ')"
fi
