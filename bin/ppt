#!/bin/bash -ue

# Runs pipenv-pytest tests locally.

usage() {
    (
        echo "usage: ${0##*/} [-h|--help] args"
        echo "Runs pipenv-pytest tests locally without xdist and with args passthru."
        echo
        echo "options:"
        (
            echo "    -h, --help@ show usage help"
            echo "    -u@ use unittest instead of pytest"
        ) | column -ts@
    ) >&2
    exit 1
}

if echo "$*" | grep -Eq -- '--help\b|-h\b'; then
    usage
fi

UNITTEST=0
INTEGRATION=0
while getopts "ui" opt; do
    case "$opt" in
    u) UNITTEST=1 ;;
    i) INTEGRATION=1 ;;
    *) usage ;;
    esac
done
shift $((OPTIND - 1))

# shellcheck source=.shell_control
# shellcheck disable=SC1091
source "$HOME/.shell_control" || echo "$(tput bold)error: ~/.shell_control not installed!$(tput sgr0)" >&2

export PIPENV_VERBOSITY="-1"
export PIPENV_QUIET="1"
if [[ $UNITTEST == "1" ]]; then
    run "pipenv run python -m unittest $*"
elif [[ $INTEGRATION == "1" ]]; then
    run "pipenv run pytest -c integration.ini -p no:pytest_django --disable-pytest-warnings -vv -x -n0 --dist no --no-header $*"
else
    run "pipenv run pytest --reuse-db --disable-pytest-warnings -vv -x -n0 --dist no --no-header $*"
fi
